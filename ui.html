<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ApexCharts → SVG 2</title>
  <link href="https://fonts.googleapis.com/css2?family=Anek+Latin:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Anek Latin', Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; 
      margin: 0; 
      height: 100vh;
      min-height: 800px;
      min-width: 1200px;
      display: flex;
      flex-direction: column;
    }
    
    
    .main-content {
      display: flex;
      flex: 1;
      height: 100vh;
      overflow: hidden;
    }
    
    .config-section {
      width: 420px;
      background: #F8F9FA;
      border-right: 1px solid #E5E7EB;
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: width 0.3s ease;
    }
    
    .config-section.collapsed {
      width: 420px;
    }
    
    .config-content {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }
    
    .config-buttons {
      padding: 16px;
      border-top: 1px solid #E5E7EB;
      background: #F8F9FA;
      flex-shrink: 0;
    }
    
    .preview-section {
      flex: 1;
      background: #F8F9FA;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      overflow: auto;
      height: 100vh;
    }
    
    .preview-section.hidden {
      display: none;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
      text-align: left;
    }
    
    .row { 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      margin: 12px 0; 
    }
    
    label { 
      width: 100px; 
      font-size: 12px; 
      color: #374151; 
      font-weight: 500;
    }
    
    input, select, textarea { 
      flex: 1; 
      font-size: 12px; 
      padding: 8px 10px; 
      border: 1px solid #D1D5DB;
      border-radius: 4px;
      background: white;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 1px #3B82F6;
    }
    
    #preview { 
      border: 1px solid #E5E7EB; 
      border-radius: 8px; 
      padding: 16px; 
      background: white;
      margin: auto;
    }
    
    .button-group {
      display: flex;
      gap: 8px;
      width: 100%;
    }
    
    button { 
      padding: 10px 16px; 
      font-size: 12px; 
      border: 1px solid #D1D5DB;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-weight: 500;
      flex: 1;
    }
    
    button:hover {
      background: #F9FAFB;
    }
    
    button#insert {
      background: #3B82F6;
      color: white;
      border-color: #3B82F6;
    }
    
    button#insert:hover {
      background: #2563EB;
    }
    
    .toggle-button {
      position: absolute;
      top: -4px;
      right: 0px;
      width: 32px;
      height: 32px;
      border: 1px solid #D1D5DB;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #6B7280;
      transition: all 0.2s ease;
      z-index: 10;
    }
    
    .toggle-button:hover {
      background: #F9FAFB;
      border-color: #9CA3AF;
      color: #374151;
    }
    
    .config-header {
      position: relative;
    }

    /* Tab styles */
    .tab-container {
      margin-top: 8px;
      width: 100%;
    }

    .tab-nav {
      display: flex;
      padding: 4px;
      gap: 4px;
      background-color: #edf2f7;
      /* border-bottom: 1px solid #E5E7EB; */
      margin-bottom: 12px;
      border-radius: 8px;
    }

    .tab-button {
      padding: 8px 16px;
      font-size: 12px;
      /* border-radius: 0px; */
      border: none;
      background: transparent;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: #6B7280;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .tab-button:hover {
      color: #374151;
      background: #F9FAFB;
    }

    .tab-button.active {
      color: #3B82F6;
      /* border-bottom-color: #3B82F6; */
      box-shadow: 0 2px 2px 0 rgba(148, 163, 184, 0.5);
      font-weight: 600;
      background-color: #ffffff;
      /* box-shadow: 0 2px 0 0 #3B82F6; */
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .tab-content textarea {
      width: 100%;
      box-sizing: border-box;
    }

    /* Table styles */
    .table-container {
      max-height: 300px;
      overflow: auto;
      border: 1px solid #E5E7EB;
      border-radius: 4px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      table-layout: fixed;
      min-width: 500px; /* Ensure minimum width for horizontal scrolling */
    }

    .data-table th,
    .data-table td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #F3F4F6;
      vertical-align: middle;
    }

    .data-table th:first-child,
    .data-table td:first-child {
      width: 100px;
      min-width: 100px;
    }

    .data-table th:not(:first-child),
    .data-table td:not(:first-child) {
      width: 150px;
      min-width: 150px;
    }

    .data-table th {
      background: #F9FAFB;
      font-weight: 600;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .data-table input {
      width: 100%;
      border: none;
      background: transparent;
      padding: 2px 4px;
      font-size: 12px;
      font-family: inherit;
    }

    .data-table input:focus {
      outline: none;
      background: white;
      border: 1px solid #3B82F6;
      border-radius: 2px;
    }

    .table-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .table-controls button {
      padding: 6px 12px;
      font-size: 11px;
      border: 1px solid #D1D5DB;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-weight: 500;
    }

    .table-controls button:hover {
      background: #F9FAFB;
    }

    .add-series-btn {
      background: #10B981 !important;
      color: white !important;
      border-color: #10B981 !important;
    }

    .add-series-btn:hover {
      background: #059669 !important;
    }

    .remove-series-btn {
      background: #EF4444 !important;
      color: white !important;
      border-color: #EF4444 !important;
    }

    .remove-series-btn:hover {
      background: #DC2626 !important;
    }

    /* X button styles for column and row removal */
    .remove-column-btn, .remove-row-btn {
      width: 16px;
      height: 16px;
      min-width: 16px;
      max-width: 16px;
      border: 0px solid #ffffff;
      border-radius: 50%;
      padding: 0;
      background: transparent;
      color: #6B7280;
      font-size: 9px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .remove-column-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }

    .remove-column-btn:hover, .remove-row-btn:hover {
      background: #EF4444;
      color: white;
      border-color: #EF4444;
      transform: scale(1.05) translateY(-50%);
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
    }

    .remove-column-btn:active, .remove-row-btn:active {
      transform: scale(0.95) translateY(-50%);
    }

    /* Series colour picker styles */
    .series-colour-picker {
      width: 20px;
      height: 20px;
      border: 2px solid #D1D5DB;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #F3F4F6;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      color: #6B7280;
      font-weight: 500;
      position: absolute;
      right: 30px;
      top: 50%;
      transform: translateY(-50%);
    }

    .series-colour-picker:hover {
      border-color: #3B82F6;
      transform: scale(1.05) translateY(-50%);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
    }

    .series-colour-picker.has-colour {
      background: var(--series-colour);
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .series-colour-picker.has-colour:hover {
      border-color: #1D4ED8;
    }

    .series-colour-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .series-header-cell {
      white-space: nowrap;
      min-height: 32px;
      padding: 6px 8px;
      overflow: hidden;
      position: relative;
    }

    .series-name-input {
      width: calc(100% - 50px); /* Account for colour picker and remove button */
      border: none;
      background: transparent;
      padding: 2px 4px;
      font-size: 12px;
      font-family: inherit;
      display: inline-block;
    }

    .series-name-input:focus {
      outline: none;
      background: white;
      border: 1px solid #3B82F6;
      border-radius: 2px;
    }

    /* Colour preset button styles */
    .colour-preset-buttons {
      display: flex;
      gap: 8px;
      flex: 1;
    }

    .colour-preset-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      font-size: 11px;
      border: 1px solid #D1D5DB;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      flex: 1;
    }

    .colour-preset-btn:hover {
      background: #F9FAFB;
      border-color: #9CA3AF;
    }

    .colour-preset-btn:active {
      background: #F3F4F6;
      transform: translateY(1px);
    }

    .colour-preset-btn.active {
      background: white;
      color: #3B82F6;
      border-color: #3B82F6;
      border-width: 2px;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }

    .colour-preset-btn.active:hover {
      background: rgba(37, 99, 235, 0.2);
      border-color: #2563EB;
    }

    .colour-swatch {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .colour-swatch-group {
      display: flex;
      gap: 2px;
    }

    .colour-swatch-group .colour-swatch {
      width: 10px;
      height: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
  <div class="main-content">
    <div class="config-section" id="configSection">
      <div class="config-content">
        <div class="config-header">
          <div class="section-title">Chart Settings</div>
          <button class="toggle-button" id="togglePreview" title="Toggle preview">
            ←
          </button>
        </div>
        
        <div class="row">
          <label for="title">Chart title</label>
          <input id="title" placeholder="e.g., Monthly VFACTS Sales" />
        </div>

        <div class="row">
          <label for="type">Type</label>
          <select id="type">
            <option value="line">Line</option>
            <option value="bar">Bar</option>
            <option value="area">Area</option>
          </select>
        </div>

        <div class="row">
          <label for="widthPreset">Width</label>
          <select id="widthPreset">
            <option value="article-desktop">Article Desktop (740px)</option>
            <option value="article-mobile">Article Mobile (350px)</option>
            <option value="full-width">Full width (1180px)</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        
        <div class="row" id="customWidthRow" style="display: none;">
          <label for="width">Width (px)</label>
          <input id="width" type="number" placeholder="600" />
        </div>
        
        <div class="row">
          <label for="height">Height (px)</label>
          <input id="height" type="number" placeholder="400" />
        </div>

        <div class="row">
          <label for="showLegend">Show legend</label>
          <input id="showLegend" type="checkbox" checked />
        </div>

        <div class="row">
          <label for="markerSize">Marker size</label>
          <input id="markerSize" type="number" placeholder="6" min="0" max="20" />
        </div>

        <div class="row">
          <label>Series colours</label>
          <div class="colour-preset-buttons">
            <button class="colour-preset-btn" data-preset="neutral" title="Apply neutral single colour to all series">
              <div class="colour-swatch" style="background-color: #AFAFB3;"></div>
              Neutral
            </button>
            <button class="colour-preset-btn" data-preset="primary-comparison" title="Apply primary and comparison colours to all series">
              <div class="colour-swatch-group">
                <div class="colour-swatch" style="background-color: #EB0800;"></div>
                <div class="colour-swatch" style="background-color: #AFAFB3;"></div>
              </div>
              Primary & Comparison
            </button>
          </div>
        </div>

        <div class="tab-container">
            <div class="tab-nav">
              <button class="tab-button active" data-tab="table">Table</button>
              <button class="tab-button" data-tab="json">JSON</button>
            </div>
            
            <div class="tab-content" id="json-tab">
              <textarea id="data" rows="8" placeholder='{"categories":["Sep 2024","Oct 2024"],"series":[{"name":"Ford Ranger (Current 12 months)","data":[5200,4950],"color":"#E11D48"},{"name":"Ford Ranger (Previous 12 months)","data":[4700,4600],"color":"#7D7D83"}]}'>{"categories":["Jan","Feb","Mar","Apr","May"],"series":[{"name":"Sales","data":[1200,1900,3000,5000,4000],"color":""},{"name":"Revenue","data":[1000,1500,2500,4200,3800],"color":""}]}</textarea>
            </div>
            
            <div class="tab-content active" id="table-tab">
              <div class="table-controls">
                <button class="add-series-btn" id="addColumn">+ Column</button>
                <button class="add-series-btn" id="addRow">+ Row</button>
              </div>
              <div class="table-container">
                <table class="data-table" id="dataTable">
                  <thead>
                    <tr id="headerRow">
                      <th>Categories</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody">
                    <!-- Table rows will be generated dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
        </div>
      </div>
      
      <div class="config-buttons">
        <div class="button-group">
          <button id="render">Render preview</button>
          <button id="insert">Insert into Figma</button>
        </div>
      </div>
    </div>
    
    <div class="preview-section" id="previewSection">
      <div id="preview"></div>
    </div>
  </div>

  <script>
    // ── Toggle functionality ─────────────────────────────────────────────────
    let previewVisible = true;
    
    function togglePreview() {
      const configSection = document.getElementById('configSection');
      const previewSection = document.getElementById('previewSection');
      const toggleButton = document.getElementById('togglePreview');
      
      previewVisible = !previewVisible;
      
      if (previewVisible) {
        // Show preview
        configSection.classList.remove('collapsed');
        previewSection.classList.remove('hidden');
        toggleButton.textContent = '←';
        toggleButton.title = 'Hide preview';
        
        // Resize window to accommodate preview
        parent.postMessage({ 
          pluginMessage: { 
            type: 'resize-window', 
            width: 1200, 
            height: 800 
          } 
        }, '*');
      } else {
        // Hide preview
        configSection.classList.add('collapsed');
        previewSection.classList.add('hidden');
        toggleButton.textContent = '→';
        toggleButton.title = 'Show preview';
        
        // Resize window to config section width only
        parent.postMessage({ 
          pluginMessage: { 
            type: 'resize-window', 
            width: 420, 
            height: 800 
          } 
        }, '*');
      }
    }
    
    document.getElementById('togglePreview').addEventListener('click', togglePreview);

    // ── Tab functionality ─────────────────────────────────────────────────
    let currentData = {
      categories: ["Jan", "Feb", "Mar", "Apr", "May"],
      series: [
        { name: "Sales", data: [1200, 1900, 3000, 5000, 4000], color: "" },
        { name: "Revenue", data: [1000, 1500, 2500, 4200, 3800], color: "" }
      ]
    };
    
    let jsonManuallyEdited = false;

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // Sync data when switching between tabs
      if (tabName === 'table') {
        // If JSON was manually edited, sync from JSON to table
        if (jsonManuallyEdited) {
          syncJsonToTable();
          jsonManuallyEdited = false; // Reset flag after syncing
        } else {
          // Always ensure table is rendered with current data
          renderTable();
        }
      } else if (tabName === 'json') {
        // Always sync table data to JSON when switching to JSON tab
        syncTableToJson();
      }
    }

    // Tab button event listeners
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        switchTab(button.dataset.tab);
      });
    });

    // ── Table management ─────────────────────────────────────────────────
    function syncJsonToTable() {
      try {
        const jsonData = JSON.parse(document.getElementById('data').value);
        if (jsonData && jsonData.categories && jsonData.series) {
          // Update currentData with JSON data
          currentData = jsonData;
          
          // Re-render table with new data
          renderTable();
        }
      } catch (e) {
        // If JSON is invalid, keep current data and just re-render
        renderTable();
      }
      jsonManuallyEdited = false; // Reset flag after syncing from JSON
    }

    function syncTableToJson() {
      const categories = [];
      const series = [];

      // Get categories from first column
      const categoryInputs = document.querySelectorAll('#tableBody tr td:first-child input');
      categoryInputs.forEach(input => {
        if (input.value.trim()) {
          categories.push(input.value.trim());
        }
      });

      // Get series data
      const headerCells = document.querySelectorAll('#headerRow th:not(:first-child)');
      headerCells.forEach((header, seriesIndex) => {
        const seriesNameInput = header.querySelector('input');
        const seriesName = seriesNameInput ? seriesNameInput.value.trim() : '';
        
        if (seriesName) {
          const seriesData = [];
          const dataInputs = document.querySelectorAll(`#tableBody tr td:nth-child(${seriesIndex + 2}) input`);
          dataInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            seriesData.push(value);
          });
          
          // Get colour from the series data (individual series colour overrides global palette)
          let seriesColor = "";
          
          // Check if this series has an individual colour set
          if (currentData.series[seriesIndex] && currentData.series[seriesIndex].color && currentData.series[seriesIndex].color.trim() !== '') {
            seriesColor = currentData.series[seriesIndex].color;
          }
          // If no individual colour, don't set color property (will use global palette)
          
          series.push({ name: seriesName, data: seriesData, color: seriesColor });
        }
      });

      // Update currentData with the latest table data
      currentData = { categories, series };
      
      // Update JSON textarea
      document.getElementById('data').value = JSON.stringify(currentData, null, 2);
      
      // Reset flag since JSON was programmatically updated
      jsonManuallyEdited = false;
    }

    function renderTable() {
      const tableBody = document.getElementById('tableBody');
      const headerRow = document.getElementById('headerRow');
      
      // Clear existing content
      tableBody.innerHTML = '';
      
      // Update header row with X buttons
      headerRow.innerHTML = '<th><input type="text" placeholder="Category" value="" /></th>';
      
      currentData.series.forEach((series, index) => {
        const th = document.createElement('th');
        th.className = 'series-header-cell';
        
        // Series name input
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'series-name-input';
        input.placeholder = 'Series name';
        input.value = series.name || '';
        input.addEventListener('input', syncTableToJson);
        
        // Series colour picker
        const colourPicker = document.createElement('div');
        colourPicker.className = 'series-colour-picker';
        colourPicker.dataset.seriesIndex = index;
        colourPicker.title = 'Click to set override colour, double-click to clear override';
        
        // Only show colour if it's an override (individual series colour set)
        if (series.color && series.color.trim() !== '') {
          colourPicker.classList.add('has-colour');
          colourPicker.style.setProperty('--series-colour', series.color);
          colourPicker.textContent = '✓';
        } else {
          colourPicker.classList.remove('has-colour');
          colourPicker.textContent = '●';
        }
        
        // Hidden colour input
        const colourInput = document.createElement('input');
        colourInput.type = 'color';
        colourInput.className = 'series-colour-input';
        colourInput.value = series.color && series.color.trim() !== '' ? series.color : '#000000';
        colourInput.addEventListener('change', function() {
          const seriesIdx = parseInt(colourPicker.dataset.seriesIndex);
          updateSeriesColour(seriesIdx, this.value);
        });
        
        colourPicker.addEventListener('click', function(e) {
          e.stopPropagation();
          colourInput.click();
        });
        
        // Double-click to clear override and return to global palette
        colourPicker.addEventListener('dblclick', function(e) {
          e.stopPropagation();
          updateSeriesColour(index, '');
        });
        
        colourPicker.appendChild(colourInput);
        
        // Add X button for removing column (but not for categories column)
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-column-btn';
        removeBtn.innerHTML = '×';
        removeBtn.title = 'Remove column';
        removeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          removeColumn(index);
        });
        
        th.appendChild(input);
        th.appendChild(colourPicker);
        th.appendChild(removeBtn);
        
        headerRow.appendChild(th);
      });
      
      // Add empty header cell for remove row buttons at the end
      const removeRowHeader = document.createElement('th');
      removeRowHeader.style.width = '40px';
      removeRowHeader.style.minWidth = '40px';
      removeRowHeader.style.textAlign = 'center';
      headerRow.appendChild(removeRowHeader);

      // Create data rows
      const maxLength = Math.max(
        currentData.categories.length,
        ...currentData.series.map(s => s.data.length)
      );

      for (let i = 0; i < maxLength; i++) {
        const row = document.createElement('tr');
        
        // Category cell
        const categoryCell = document.createElement('td');
        const categoryInput = document.createElement('input');
        categoryInput.type = 'text';
        categoryInput.placeholder = 'Category';
        categoryInput.value = currentData.categories[i] || '';
        categoryInput.addEventListener('input', syncTableToJson);
        categoryCell.appendChild(categoryInput);
        row.appendChild(categoryCell);

        // Series data cells
        currentData.series.forEach((series, seriesIndex) => {
          const dataCell = document.createElement('td');
          const dataInput = document.createElement('input');
          dataInput.type = 'number';
          dataInput.placeholder = '0';
          dataInput.value = series.data[i] || '';
          dataInput.addEventListener('input', syncTableToJson);
          dataCell.appendChild(dataInput);
          row.appendChild(dataCell);
        });

        // Add X button for removing row in a separate cell
        const removeRowCell = document.createElement('td');
        removeRowCell.style.textAlign = 'center';
        removeRowCell.style.width = '40px';
        removeRowCell.style.minWidth = '40px';
        const removeRowBtn = document.createElement('button');
        removeRowBtn.className = 'remove-row-btn';
        removeRowBtn.innerHTML = '×';
        removeRowBtn.title = 'Remove row';
        removeRowBtn.addEventListener('click', () => removeRow(i));
        removeRowCell.appendChild(removeRowBtn);
        row.appendChild(removeRowCell);

        tableBody.appendChild(row);
      }
    }

    function addColumn() {
      currentData.series.push({ name: `Series ${currentData.series.length + 1}`, data: new Array(currentData.categories.length).fill(0), color: "" });
      renderTable();
      syncTableToJson();
    }

    function updateSeriesColour(seriesIndex, colour) {
      if (currentData.series[seriesIndex]) {
        // Set the individual series colour (this overrides the global palette)
        // If colour is empty or default, clear the override
        if (colour && colour.trim() !== '' && colour !== '#000000') {
          currentData.series[seriesIndex].color = colour;
        } else {
          currentData.series[seriesIndex].color = '';
        }
        
        // Update the colour picker display without re-rendering the entire table
        const colourPicker = document.querySelector(`[data-series-index="${seriesIndex}"]`);
        if (colourPicker) {
          // Get the existing colour input before updating content
          const existingColourInput = colourPicker.querySelector('.series-colour-input');
          
          // Only show as having colour if it's a real override
          if (currentData.series[seriesIndex].color && currentData.series[seriesIndex].color.trim() !== '') {
            colourPicker.classList.add('has-colour');
            colourPicker.style.setProperty('--series-colour', currentData.series[seriesIndex].color);
            colourPicker.textContent = '✓';
          } else {
            colourPicker.classList.remove('has-colour');
            colourPicker.textContent = '●';
          }
          
          // Re-append the colour input if it existed
          if (existingColourInput) {
            existingColourInput.value = currentData.series[seriesIndex].color || '#000000';
            colourPicker.appendChild(existingColourInput);
          }
        }
        
        // Always sync to JSON to ensure persistence when switching tabs
        syncTableToJson();
        
        // Update preset active state in case individual changes affect it
        const currentPreset = detectCurrentPreset();
        if (currentPreset) {
          updatePresetActiveState(currentPreset);
        } else {
          // Clear all active states if no preset matches
          document.querySelectorAll('.colour-preset-btn').forEach(btn => {
            btn.classList.remove('active');
          });
        }
      }
    }

    function removeColumn(columnIndex) {
      if (currentData.series.length > 1) {
        currentData.series.splice(columnIndex, 1);
        renderTable();
        syncTableToJson();
      }
    }

    function addRow() {
      currentData.categories.push(`Category ${currentData.categories.length + 1}`);
      currentData.series.forEach(series => {
        series.data.push(0);
      });
      renderTable();
      syncTableToJson();
    }

    function removeRow(rowIndex) {
      if (currentData.categories.length > 1) {
        currentData.categories.splice(rowIndex, 1);
        currentData.series.forEach(series => {
          series.data.splice(rowIndex, 1);
        });
        renderTable();
        syncTableToJson();
      }
    }

    function applyColourPreset(preset) {
      let colours = [];
      
      switch (preset) {
        case 'neutral':
          // Set neutral colour palette
          colours = ['#AFAFB3'];
          break;
        case 'primary-comparison':
          // Set primary and comparison colour palette
          colours = ['#EB0800', '#AFAFB3'];
          break;
        default:
          return;
      }

      // Update the global BRAND palette
      BRAND.palette = colours;

      // Clear individual series colours to use the global palette
      currentData.series.forEach(series => {
        series.color = '';
      });

      // Update active state
      updatePresetActiveState(preset);

      // Re-render table to show updated colours
      renderTable();
      syncTableToJson();
    }

    function updatePresetActiveState(activePreset) {
      // Remove active class from all preset buttons
      document.querySelectorAll('.colour-preset-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Add active class to the selected preset
      const activeButton = document.querySelector(`[data-preset="${activePreset}"]`);
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }

    function detectCurrentPreset() {
      // Check if current palette matches any preset
      const currentPalette = BRAND.palette;
      
      if (JSON.stringify(currentPalette) === JSON.stringify(['#AFAFB3'])) {
        return 'neutral';
      } else if (JSON.stringify(currentPalette) === JSON.stringify(['#EB0800', '#AFAFB3'])) {
        return 'primary-comparison';
      }
      
      return null; // No preset matches
    }

    // Table control event listeners
    document.getElementById('addColumn').addEventListener('click', addColumn);
    document.getElementById('addRow').addEventListener('click', addRow);

    // Colour preset event listeners
    document.querySelectorAll('.colour-preset-btn').forEach(button => {
      button.addEventListener('click', function() {
        const preset = this.dataset.preset;
        applyColourPreset(preset);
      });
    });

    // Sync JSON to table when JSON textarea changes
    document.getElementById('data').addEventListener('input', () => {
      jsonManuallyEdited = true; // Mark that JSON has been manually edited
      if (document.getElementById('table-tab').classList.contains('active')) {
        syncJsonToTable();
        jsonManuallyEdited = false; // Reset since we just synced
      }
    });

    // Initialize table on page load
    renderTable();

    // ── Brand tokens (edit once, used everywhere) ────────────────────────────
    var BRAND = {
      fontFamily: "'Anek Latin', Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif",
      foreColor: "#0F172A",     // text
      axisColor: "#334155",     // axis/labels
      subtitleColor: "#475569",
      gridColor: "#E2E8F0",
      palette: ["#E11D48","#7D7D83","#22C55E","#F59E0B","#8B5CF6","#10B981","#F43F5E"],
      sizes: { label: "12px", legend: "12px", title: "16px", subtitle: "12px", dataLabel: "12px" },
      weights: { label: 400, legend: 500, title: 600, subtitle: 500, dataLabel: 600 }
    };
    
    // Set initial active state based on current palette (after BRAND is defined)
    const currentPreset = detectCurrentPreset();
    if (currentPreset) {
      updatePresetActiveState(currentPreset);
    }

    var chart = null;

    function parseData(raw) {
      try { return JSON.parse(raw); } catch(e) { return null; }
    }

    // ── Width preset handling ───────────────────────────────────────────────
    function getWidthValue() {
      var preset = document.getElementById('widthPreset').value;
      var customWidth = parseInt(document.getElementById('width').value, 10);
      
      switch (preset) {
        case 'article-desktop':
          return 740;
        case 'article-mobile':
          return 350;
        case 'full-width':
          return 1180;
        case 'custom':
          return customWidth || 600;
        default:
          return 600;
      }
    }
    
    function handleWidthPresetChange() {
      var preset = document.getElementById('widthPreset').value;
      var customRow = document.getElementById('customWidthRow');
      
      if (preset === 'custom') {
        customRow.style.display = 'flex';
      } else {
        customRow.style.display = 'none';
      }
    }

    // ── Branded defaults (keeps width/height support) ───────────────────────
    function baseOptions() {
      var type = document.getElementById('type').value;
      var width = getWidthValue();
      var height = parseInt(document.getElementById('height').value, 10) || 400;

      return {
        chart: {
          type: type,
          width: width,
          height: height,
          fontFamily: BRAND.fontFamily,
          foreColor: BRAND.foreColor,
          animations: { enabled: false },
          toolbar: { show: false }
        },
        colors: BRAND.palette,

        title: {
          text: document.getElementById('title').value || "",
          style: {
            fontSize: BRAND.sizes.title,
            fontWeight: BRAND.weights.title,
            fontFamily: BRAND.fontFamily,
            color: BRAND.foreColor
          }
        },
        subtitle: {
          text: "",
          style: {
            fontSize: BRAND.sizes.subtitle,
            fontWeight: BRAND.weights.subtitle,
            fontFamily: BRAND.fontFamily,
            color: BRAND.subtitleColor
          }
        },

        xaxis: {
          categories: [],
          axisBorder: { show: true, color: BRAND.gridColor },
          axisTicks:  { show: true, color: BRAND.gridColor },
          crosshairs: {
            show: false
          },
          labels: {
            style: {
              colors: BRAND.axisColor,
              fontSize: BRAND.sizes.label,
              fontFamily: BRAND.fontFamily,
              fontWeight: BRAND.weights.label
            }
          }
        },
        yaxis: {
          crosshairs: {
            show: false
          },
          labels: {
            formatter: function(v){ return Number(v).toLocaleString(); },
            style: {
              colors: BRAND.axisColor,
              fontSize: BRAND.sizes.label,
              fontFamily: BRAND.fontFamily,
              fontWeight: BRAND.weights.label
            }
          }
        },

        grid: { 
          borderColor: BRAND.gridColor, 
          strokeDashArray: 3, 
          padding: { left: 8, right: 8 },
          xaxis: {
            lines: {
              show: false
            }
          }
        },
        stroke: { width: (type === "bar" ? 0 : 2), lineCap: "round", curve: "smooth" },
        markers: { size: ((type === "line" || type === "area") ? (parseInt(document.getElementById('markerSize').value, 10) || 5) : 0), strokeWidth: 2, strokeColors: "#fff" },

        plotOptions: {
          bar: { columnWidth: "55%", borderRadius: 6 },
          area: { fillTo: "origin" }
        },
        fill: {
          type: "solid",
          opacity: (type === "area" ? 0.18 : 1)
        },

        dataLabels: {
          enabled: false,
          style: {
            fontSize: BRAND.sizes.dataLabel,
            fontFamily: BRAND.fontFamily,
            fontWeight: BRAND.weights.dataLabel,
            colors: [BRAND.foreColor]
          }
        },

        legend: {
          show: true,
          position: "bottom",
          horizontalAlign: "center",
          fontSize: BRAND.sizes.legend,
          fontFamily: BRAND.fontFamily,
          fontWeight: BRAND.weights.legend,
          markers: { 
            radius: 3,
            strokeWidth: 0,
            strokeColor: '#fff'
          },
          itemMargin: {
            horizontal: 10,
            vertical: 5
          },
          offsetY: 5
        },

        tooltip: {
          theme: "light",
          style: { fontSize: BRAND.sizes.label, fontFamily: BRAND.fontFamily },
          x: { formatter: function(val){ return val; } },
          y: { formatter: function(v){ return Number(v).toLocaleString(); } },
          enabled: true,
          shared: true,
          intersect: false,
          followCursor: false,
          custom: undefined,
          crosshairs: {
            show: false
          }
        },

        series: []
      };
    }

    async function render() {
      // If we're on JSON tab and JSON was manually edited, parse from JSON textarea
      // Otherwise use currentData
      var json;
      if (document.getElementById('json-tab').classList.contains('active') && jsonManuallyEdited) {
        try {
          json = JSON.parse(document.getElementById('data').value);
        } catch (e) {
          parent.postMessage({ pluginMessage: { type: 'notify', message: 'Invalid JSON format' } }, '*');
          return;
        }
      } else {
        json = currentData;
      }
      
      if (!json || !Array.isArray(json.series)) {
        parent.postMessage({ pluginMessage: { type: 'notify', message: 'Invalid data: expected { categories, series }' } }, '*');
        return;
      }

      var options = baseOptions();
      
      // Process series to handle per-series colours
      var processedSeries = json.series.map(function(series, index) {
        var processedSeries = {
          name: series.name,
          data: series.data
        };
        
        // If series has a custom colour, add it to the series object
        if (series.color && series.color.trim() !== '') {
          processedSeries.color = series.color;
        }
        
        return processedSeries;
      });
      
      options.series = processedSeries;
      options.xaxis.categories = json.categories || [];
      
      // Show legend based on user preference and data
      var legendCheckbox = document.getElementById('showLegend').checked;
      var hasMultipleSeriesOrNames = json.series.length > 1 || (json.series.length === 1 && json.series[0].name);
      var showLegend = legendCheckbox && hasMultipleSeriesOrNames;
      options.legend.show = showLegend;

      var el = document.getElementById('preview');
      el.innerHTML = '';
      chart = new ApexCharts(el, options);
      await chart.render();
      
      // Debug: Check if legend was rendered
      setTimeout(function() {
        var svg = document.querySelector('#preview svg');
        var previewDiv = document.querySelector('#preview');
        
        if (svg) {
          var legendElements = svg.querySelectorAll('.apexcharts-legend, .apexcharts-legend-series, .apexcharts-legend-text');
          console.log('After render - Legend elements in SVG:', legendElements.length);
          
          // Check if legend exists outside SVG in the preview div
          var legendOutsideSvg = previewDiv.querySelectorAll('.apexcharts-legend, .apexcharts-legend-series, .apexcharts-legend-text');
          console.log('Legend elements outside SVG:', legendOutsideSvg.length);
          
          console.log('Legend show setting:', showLegend);
          console.log('Series count:', json.series.length);
          if (json.series.length > 0) {
            console.log('Series names:', json.series.map(s => s.name));
          }
          
          // Log all elements in preview to see what's there
          console.log('All elements in preview:', previewDiv.children.length);
          for (var i = 0; i < previewDiv.children.length; i++) {
            console.log('Child', i, ':', previewDiv.children[i].tagName, previewDiv.children[i].className);
          }
        }
      }, 100);

    }


    function createManualLegend(svgClone, seriesData) {
      if (!seriesData || seriesData.length === 0) return;
      
      // Only create legend if we have multiple series or single series with a name
      var shouldCreateLegend = seriesData.length > 1 || (seriesData.length === 1 && seriesData[0].name);
      if (!shouldCreateLegend) return;
      
      // Get SVG dimensions
      var svgWidth = parseFloat(svgClone.getAttribute('width')) || 600;
      var svgHeight = parseFloat(svgClone.getAttribute('height')) || 400;
      
      // Calculate legend dimensions
      var itemWidth = 120; // Approximate width per legend item
      var itemHeight = 20;
      var itemSpacing = 10;
      
      // Filter series with names
      var namedSeries = seriesData.filter(function(series) { return series.name; });
      var legendWidth = namedSeries.length * itemWidth;
      var legendHeight = itemHeight;
      
      // Position legend at bottom center with proper spacing from x-axis
      var legendX = (svgWidth - legendWidth) / 2;
      var legendY = svgHeight - 25; // Moved down a tad - closer to bottom edge
      
      // Create legend group
      var legendGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      legendGroup.setAttribute('class', 'manual-legend');
      legendGroup.setAttribute('transform', 'translate(' + legendX + ', ' + legendY + ')');
      
      var currentX = 0;
      
      namedSeries.forEach(function(series, index) {
        // Create legend item group
        var itemGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        itemGroup.setAttribute('transform', 'translate(' + currentX + ', 0)');
        
        // Create legend marker (circle)
        var marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        marker.setAttribute('cx', '6');
        marker.setAttribute('cy', '10');
        marker.setAttribute('r', '3');
        
        // Use series-specific colour if available, otherwise fall back to palette
        var seriesColour = series.color;
        if (!seriesColour || seriesColour.trim() === '') {
          var currentPalette = parseCustomColours() || BRAND.palette;
          seriesColour = currentPalette[index % currentPalette.length];
        }
        marker.setAttribute('fill', seriesColour);
        
        // Create legend text
        var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', '16');
        text.setAttribute('y', '14');
        text.setAttribute('font-family', BRAND.fontFamily);
        text.setAttribute('font-size', BRAND.sizes.legend);
        text.setAttribute('font-weight', BRAND.weights.legend);
        text.setAttribute('fill', BRAND.foreColor);
        text.textContent = series.name;
        
        itemGroup.appendChild(marker);
        itemGroup.appendChild(text);
        legendGroup.appendChild(itemGroup);
        
        currentX += itemWidth;
      });
      
      // Insert legend at the end of SVG (so it appears on top)
      svgClone.appendChild(legendGroup);
    }

    function getSvgString() {
      var svg = document.querySelector('#preview svg');
      if (!svg) return null;
      
      // Clone the SVG to avoid modifying the original
      var svgClone = svg.cloneNode(true);
      
      // Check if legend exists in SVG
      var legendElements = svgClone.querySelectorAll('.apexcharts-legend, .apexcharts-legend-series, .apexcharts-legend-text');
      var hasLegend = legendElements.length > 0;
      
      // If no legend found in SVG, but user wants legend and we have multiple series, create manual legend
      var userWantsLegend = document.getElementById('showLegend').checked;
      if (!hasLegend && userWantsLegend && chart && chart.w && chart.w.config && chart.w.config.series) {
        var seriesData = chart.w.config.series;
        if (seriesData.length > 1 || (seriesData.length === 1 && seriesData[0].name)) {
          console.log('Creating manual legend for', seriesData.length, 'series');
          createManualLegend(svgClone, seriesData);
          hasLegend = true;
        }
      }
      
      // Ensure all text elements have explicit font-family attributes
      var textElements = svgClone.querySelectorAll('text, tspan');
      textElements.forEach(function(textElement) {
        // Set explicit font-family attribute
        textElement.setAttribute('font-family', "'Anek Latin', Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif");
        
        // Also set font-weight if not already set
        if (!textElement.getAttribute('font-weight')) {
          var computedStyle = window.getComputedStyle(textElement);
          textElement.setAttribute('font-weight', computedStyle.fontWeight || '400');
        }
        
        // Set font-size if not already set
        if (!textElement.getAttribute('font-size')) {
          var computedStyle = window.getComputedStyle(textElement);
          textElement.setAttribute('font-size', computedStyle.fontSize || '12px');
        }
      });
      
      console.log('Final SVG has legend:', hasLegend);
      return svgClone.outerHTML;
    }

    // Width preset event listener
    document.getElementById('widthPreset').addEventListener('change', handleWidthPresetChange);

    document.getElementById('render').addEventListener('click', render);

    document.getElementById('insert').addEventListener('click', async function () {
      if (!chart) { await render(); }
      var svg = getSvgString();
      var title = document.getElementById('title').value || 'Apex Chart';
      
      var width = getWidthValue();
      var height = parseInt(document.getElementById('height').value, 10) || 400;
      
      var meta = { 
        title: title,
        width: width,
        height: height
      };
      
      if (svg) {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'insert-svg', 
            svg: svg, 
            meta: meta
          } 
        }, '*');
      }
    });
  </script>
</body>
</html>
